{% extends 'cardDatabase/html/base.html' %}
{% load static card_database_tags %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/bootstrap/mdb.css' %}">
    <link rel="stylesheet" href="{% static 'css/database_base.css' %}">
    <link rel="stylesheet" href="{% static 'css/search.css' %}">
    <link rel="stylesheet" href="{% static 'css/decklist_search.css' %}">
    <link rel="stylesheet" href="{% static 'css/user_decklists.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}

{% block mobilecss %}
    {{ block.super }}
    {% if request.user_agent.is_mobile or request.user_agent.is_tablet %}
        <link rel="stylesheet" href="{% static 'css/search_mobile.css' %}">
        <link rel="stylesheet" href="{% static 'css/decklist_search_mobile.css' %}">
        <link rel="stylesheet" href="{% static 'css/user_decklists_mobile.css' %}">
    {% endif %}
{% endblock %}

{% block js %}
    {{ block.super }}
    <script src="{% static 'js/bootstrap/bootstrap.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/bootstrap/mdb.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/search.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/decklist_search.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/user_decklists.js' %}" type="text/javascript"></script>
    <script type="text/javascript">
        let FOWDB_CURRENT_PAGE = {{ decklists.number }};
        let FOWDB_TOTAL_PAGES = {{ decklists.paginator.num_pages }};
    </script>
{% endblock %}

{% block body %}
    <div class="container-fluid user-decklists-container">
        <!-- Header with title and create button -->
        <div class="header-section">
            <h1>
                {% if is_owner %}
                    My Decklists
                {% else %}
                    {{ viewed_user.username }}'s Decklists
                {% endif %}
            </h1>
            {% if is_owner %}
                <button id="create-deck" class="btn btn-primary" data-toggle="modal" data-target="#deck-format-modal">
                    Create New Deck
                </button>
            {% endif %}
        </div>

        <!-- Search and Filter Form -->
        <div class="search-filter-section">
            <form id="decklist-search-form" method="get">
                <input type="hidden" name="form_type" value="decklist-form">

                <!-- Card Name Search -->
                <div class="fieldWrapper search-card-name">
                    <label for="id_contains_card">Search by Card Name:</label>
                    {{ decklist_form.contains_card }}
                </div>

                <!-- Text Exactness -->
                <div class="fieldWrapper text-exactness">
                    <label>Match words:</label>
                    {% for value, display in decklist_form.text_exactness.field.choices %}
                        <label for="id_text_exactness_{{ forloop.counter0 }}">
                            <input type="radio" name="text_exactness"
                                   id="id_text_exactness_{{ forloop.counter0 }}"
                                   value="{{ value }}"
                                   {% if value == decklist_form.text_exactness.value %}checked{% endif %}>
                            {{ display }}
                        </label>
                    {% endfor %}
                </div>

                <!-- Format Filter -->
                <div class="fieldWrapper format-filter">
                    <label for="id_deck_format">Format(s):</label>
                    <select class="mdb-select md-form" multiple name="deck_format" searchable="Search formats...">
                        {% for format in formats %}
                            <option value="{{ format.name }}"
                                {% if format.name in decklist_form.deck_format.value %}selected{% endif %}>
                                {{ format.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sort Options -->
                <div class="fieldWrapper sort-options">
                    <label for="sort_by">Sort by:</label>
                    <select name="sort_by" id="sort_by">
                        {% for value, display in sort_choices %}
                            <option value="{{ value }}"
                                {% if value == request.GET.sort_by %}selected{% endif %}>
                                {{ display }}
                            </option>
                        {% endfor %}
                    </select>

                    <label for="reverse_sort" class="reverse-sort-label">
                        <input type="checkbox" name="reverse_sort" id="reverse_sort" value="true"
                               {% if request.GET.reverse_sort == "true" %}checked{% endif %}>
                        Reverse Order
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="form-submit-button">
                    <input type="submit" value="Search & Filter" class="btn btn-primary">
                    <a href="{% url 'cardDatabase-view-users-decklist' viewed_user.username %}"
                       class="btn btn-secondary">Clear Filters</a>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            {% if decklists %}
                <!-- Results Count and Pagination -->
                <div class="results-header">
                    <div class="results-count">
                        Showing {{ decklists.start_index }}-{{ decklists.end_index }} of {{ total_results }} decklist(s)
                    </div>

                    {% if decklists.has_other_pages %}
                        {% comment %}
                        js sets the href of the <a> tags using data-page-index because it needs to maintain all the other query params
                        {% endcomment %}
                        <div id="other-pages-top" class="pagination">
                            <div class="pagination-content">
                                {% if decklists.has_previous %}
                                    <a data-page-index="{{ decklists.previous_page_number }}">
                                        <div class="pagination-page valid-choice">
                                            &laquo;
                                        </div>
                                    </a>
                                {% else %}
                                    <div class="pagination-page disabled-choice">
                                        &laquo;
                                    </div>
                                {% endif %}
                                {% for page_num in page_range %}
                                    {% if page_num == decklists.number %}
                                        <div class="pagination-page current-page">
                                            {{ page_num }}
                                        </div>
                                    {% else %}
                                        {% if page_num == decklists.paginator.ELLIPSIS %}
                                            <div class="pagination-page pagination-ellipsis">
                                                {{ page_num }}
                                            </div>
                                        {% else %}
                                            <a data-page-index="{{ page_num }}">
                                                <div class="pagination-page valid-choice">
                                                    {{ page_num }}
                                                </div>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if decklists.has_next %}
                                    <a data-page-index="{{ decklists.next_page_number }}">
                                        <div class="pagination-page valid-choice">
                                            &raquo;
                                        </div>
                                    </a>
                                {% else %}
                                    <div class="pagination-page disabled-choice">
                                        &raquo;
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Decklist Grid -->
                <div class="decklist-grid">
                    {% for decklist in decklists %}
                        <div class="decklist-card">
                            <!-- Card Image -->
                            <div class="decklist-image">
                                {% if decklist.get_front_card_of_deck %}
                                    <a href="{% url 'cardDatabase-view-decklist' decklist.id %}">
                                        <img src="{{ decklist.get_front_card_of_deck.card.card_image.url }}"
                                             alt="{{ decklist.name }}">
                                    </a>
                                {% else %}
                                    <div class="no-image">No cards</div>
                                {% endif %}
                            </div>

                            <!-- Decklist Info -->
                            <div class="decklist-info">
                                <h3 class="decklist-name">
                                    <a href="{% url 'cardDatabase-view-decklist' decklist.id %}">
                                        {% trucateText decklist.name %}
                                    </a>
                                </h3>

                                <!-- Colors -->
                                <div class="decklist-colors">
                                    {% colours_to_imgs decklist.get_colours %}
                                </div>

                                <!-- Meta Information -->
                                <div class="decklist-meta">
                                    <span class="card-count">{% decklist_card_count decklist %} cards</span>
                                    <span class="format">Format: {{ decklist.deck_format.name }}</span>
                                    <span>
                                        Last Modified: 
                                        <span class="block local-date-time sm-text" data-localizable-dt="{% datetime_to_timestamp decklist.last_modified %}" data-date-only="true" title="Last Modified"></span>
                                    </span>
                                    

                                    {% if is_owner %}
                                        <span class="public-status">
                                            Visibility: 
                                            {% if decklist.public %}
                                                Public <i class="fa-regular fa-eye"></i>
                                            {% else %}
                                                Private <i class="fa-regular fa-eye-slash"></i>
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                </div>

                                <!-- Action Buttons (Owner Only) -->
                                {% if is_owner %}
                                    <div class="decklist-actions">
                                        {% if request.user_agent.is_mobile or request.user_agent.is_tablet %}
                                            <a href="{% url 'cardDatabase-edit-decklist-mobile' decklist.id %}"
                                                class="btn btn-sm btn-primary">Edit</a>
                                        {% else %}
                                            <a href="{% url 'cardDatabase-edit-decklist' decklist.id %}"
                                            class="btn btn-sm btn-primary">Edit</a>
                                        {% endif %}
                                        <button class="btn btn-sm btn-danger delete-deck"
                                                data-deck-id="{{ decklist.id }}"
                                                data-deck-name="{{ decklist.name }}">Delete</button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                {% if decklists.has_other_pages %}
                    <div id="other-pages-bottom" class="pagination">{% comment %}Paginators behave weird when making duplicates. Copy the first one into here on load{% endcomment %}</div>
                {% endif %}

            {% else %}
                <!-- Empty State -->
                <div class="empty-state">
                    {% if request.GET.form_type == "decklist-form" %}
                        <!-- No results found -->
                        <img src="{% get_random_chibi 'sad' %}" alt="No results">
                        <p>No decklists match your search criteria.</p>
                        <a href="{% url 'cardDatabase-view-users-decklist' viewed_user.username %}"
                           class="btn btn-primary">Clear Filters</a>
                    {% else %}
                        <!-- No decklists yet -->
                        <img src="{% get_random_chibi 'greetings' %}">
                        <p>
                            {% if is_owner %}
                                You don't have any decklists yet. Create one to get started!
                            {% else %}
                                {{ viewed_user.username }} doesn't have any public decklists yet.
                            {% endif %}
                        </p>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- Format Selection Modal (Owner Only) -->
        {% if is_owner %}
            <div class="modal fade" id="deck-format-modal" tabindex="-1" role="dialog" aria-labelledby="deck-format-modal-label" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="deck-format-modal-label">Format select</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        </div>
                        <div class="modal-body format-modal-body">
                            {% for format in formats %}
                                <a href="{% url 'cardDatabase-create-decklist' format.name %}">
                                    <div class="format-tile">
                                        <span>{{format.name}}</span>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
